# Архітектура проекту CarCanvas Intersections

## 1. Вступ

### 1.1. Мета документа
Цей документ описує архітектурні рішення, структуру та принципи роботи вебзастосунку **CarCanvas Intersections**. Він призначений для розробників, які підтримуватимуть або розширюватимуть систему, забезпечуючи швидке входження в проект.

### 1.2. Основні поняття та терміни
*   **Car (Машина)**: Набір 2D точок, що завантажуються з файлу, які можуть трансформуватися (переміщуватися та обертатися) як єдине ціле.
*   **Canvas (Сцена)**: Область відображення розміром 2000x400 пікселів, де відбувається рендеринг машин та ліній.
*   **Intersection (Перетин)**: Факт накладання пікселя машини на піксель іншої машини або лінії.
*   **PixelSet**: Оптимізована структура даних (`HashSet<int>`), що зберігає всі координати точок машини після трансформації для швидкого пошуку перетинів.
*   **Bresenham Algorithm**: Алгоритм растеризації для побудови ліній.

### 1.3. Загальний опис системи
CarCanvas Intersections — це Single Page Application (SPA), побудований на базі **Blazor WebAssembly**. Застосунок дозволяє візуалізувати дві "машини", керувати їх положенням, додавати довільні лінії та виконувати пошук перетинів у реальному часі з відображенням статистики продуктивності.

---

## 2. Архітектурний огляд

Система побудована за принципами **Clean Architecture (Onion Architecture)**, що забезпечує слабку зв'язність компонентів та легкість тестування.

### 2.1. Діаграма високого рівня

```mermaid
graph TD
    User[Користувач] -->|Взаємодія| UI[Web (Blazor WASM)]
    UI -->|Виклики| VM[ViewModels]
    VM -->|Використання| App[Application Layer]
    App -->|Інтерфейси| Domain[Domain Layer]
    App -->|Реалізація| Infra[Infrastructure Layer]
    Infra -->|Алгоритми| Algos[Bresenham, Geometry]
    Infra -->|Дані| File[File Loader]
```

### 2.2. Опис основних шарів
1.  **Domain (Ядро)**: Містить основні сутності (`CarModel`, `Point2D`) та логіку, незалежну від зовнішніх факторів.
2.  **Application (Застосунок)**: Визначає інтерфейси сервісів (`IIntersectionService`, `ICarLoader`) та DTO. Керує бізнес-сценаріями.
3.  **Infrastructure (Інфраструктура)**: Реалізує інтерфейси Application. Містить конкретні алгоритми та роботу з зовнішніми ресурсами (HTTP, файли).
4.  **Web (UI)**: Презентаційний шар на Blazor, що відповідає за відображення та взаємодію з користувачем.

---

## 3. Детальний опис компонентів

### 3.1. Domain Layer (`CarCanvas.Domain`)
*   **Point2D**: Базова структура для координат `(int X, int Y)`.
*   **LineSegment**: Представляє відрізок двома точками (`Start`, `End`).
*   **Transform**: Value Object для зберігання стану трансформації (`TranslateX`, `TranslateY`, `RotationAngle`).
*   **CarModel**: Сутність машини. Зберігає оригінальні точки, поточну трансформацію та обчислює центр обертання.

### 3.2. Application Layer (`CarCanvas.Application`)
*   **ICarLoader**: Інтерфейс завантаження точок машини.
*   **IIntersectionService**: Основний контракт для пошуку перетинів.
*   **ICanvasSceneService**: Абстракція для роботи з графічним канвасом (дозволяє замінити реалізацію рендерингу).
*   **IntersectionResult**: DTO з результатами пошуку (час виконання, кількість перетинів, точки маркерів).

### 3.3. Infrastructure Layer (`CarCanvas.Infrastructure`)
*   **CarFileLoader**: Реалізує `ICarLoader`. Завантажує та парсить файл `Logan.txt` через HTTP.
*   **IntersectionService**: 
    *   Реалізує логіку пошуку перетинів.
    *   **Особливість**: Використовує кешування `PixelSet`. Якщо трансформація машини не змінилася, повторно використовує попередньо розрахований набір пікселів.
    *   Використовує хешування параметрів трансформації для інвалідації кешу.
*   **Bresenham**: Статичний клас для генерації точок лінії (растеризація).
*   **PointTransformer**: Виконує математичні операції обертання та зміщення точок.

### 3.4. Web Layer (`CarCanvas.Web`)
*   **DashboardViewModel**: Керує станом сторінки. Зв'язує UI з бізнес-логікою. Реалізує патерн MVVM.
*   **CanvasSceneService**: Реалізує `ICanvasSceneService` через JS Interop (`canvasHelper.js`) для малювання на HTML5 Canvas.
*   **Компоненти**:
    *   `CanvasView`: Обгортка над HTML `<canvas>`.
    *   `CarControlPanel`: Панель керування параметрами машини.
    *   `LineControlPanel`: Панель додавання/генерації ліній.

---

## 4. Потоки даних

### 4.1. Сценарій: Завантаження застосунку
1.  `Home.razor` ініціалізує `DashboardViewModel`.
2.  `ViewModel` викликає `CarLoader` для отримання точок з `Logan.txt`.
3.  Створюються два екземпляри `CarModel`.
4.  Викликається `DrawSceneAsync` для первинного відображення.

### 4.2. Сценарій: Пошук перетинів
1.  Користувач натискає "Show Intersections".
2.  `ViewModel` викликає `IntersectionService.FindIntersectionsAsync`.
3.  **Infrastructure**:
    *   Перевіряє кеш `PixelSet` для обох машин. Якщо змінено — перераховує точки (Transform -> Rotate -> Translate).
    *   Формує `HashSet<int>` (де ключ = `y * width + x`).
    *   Проходить по всіх лініях алгоритмом Брезенхема.
    *   Перевіряє наявність точок ліній у `PixelSet` машини.
    *   Перевіряє перетин `PixelSet` двох машин.
4.  Результат (`IntersectionResult`) повертається у `ViewModel`.
5.  `ViewModel` оновлює UI та викликає малювання маркерів на Canvas.

---

## 5. Технічні деталі

### 5.1. Технологічний стек
*   **Платформа**: .NET 8.0
*   **Фреймворк UI**: Blazor WebAssembly
*   **Рендеринг**: HTML5 Canvas 2D Context (через JS Interop)
*   **Контейнеризація**: Docker, Docker Compose
*   **Веб-сервер (prod)**: Nginx (Alpine Linux)

### 5.2. Вимоги до продуктивності
*   **Pixel-based collision**: Використання хеш-сетів забезпечує складність перевірки точки O(1).
*   **Async/Await**: Важкі операції розрахунку виконуються асинхронно (`Task.Run`), щоб не блокувати UI потік браузера.
*   **Batch Rendering**: Точки передаються в JavaScript масивами (batch), щоб мінімізувати кількість викликів між .NET та JS (Marshalling overhead).

### 5.3. Конфігурація (`AppOptions`)
*   `CanvasWidth`: 2000 px
*   `CanvasHeight`: 400 px
*   `StrideKey`: 2000 (множник для унікального ключа пікселя `Y * Stride + X`)

---

## 6. Додатки

### 6.1. Глосарій
*   **ViewModel**: Клас, що зберігає стан представлення та методи обробки команд користувача.
*   **Dependency Injection (DI)**: Патерн проектування, використаний для реєстрації сервісів у `Program.cs`.

### 6.2. Пов'язані файли
*   [README.md](./README.md) - Інструкція із запуску.
*   [Logan.txt](./src/CarCanvas.Web/wwwroot/Logan.txt) - Файл з координатами точок.
