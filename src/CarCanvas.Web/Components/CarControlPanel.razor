@using CarCanvas.Domain.Entities
@using CarCanvas.Web.ViewModels

<div class="card mb-3">
    <div class="card-header bg-light">
        <strong>@Title</strong>
    </div>
    <div class="card-body">
        @if (Car != null)
        {
            <div class="row g-2 align-items-center mb-2">
                <div class="col-auto">
                    <label class="col-form-label small">X Translate:</label>
                </div>
                <div class="col">
                    <input type="number" class="form-control form-control-sm" value="@Car.Transform.TranslateX" 
                           @onchange="@(e => OnTransformChanged("x", e.Value))" />
                </div>
            </div>
            <div class="row g-2 align-items-center mb-2">
                <div class="col-auto">
                    <label class="col-form-label small">Y Translate:</label>
                </div>
                <div class="col">
                    <input type="number" class="form-control form-control-sm" value="@Car.Transform.TranslateY" 
                           @onchange="@(e => OnTransformChanged("y", e.Value))" />
                </div>
            </div>
            <div class="row g-2 align-items-center mb-1">
                <div class="col-auto">
                    <label class="col-form-label small">Rotation angle:</label>
                </div>
                <div class="col">
                    <input type="number" class="form-control form-control-sm" value="@Car.Transform.RotationAngle" 
                           @onchange="@(e => OnTransformChanged("rot", e.Value))" />
                </div>
            </div>
            <div class="mb-3 text-muted text-end" style="font-size: 0.7em;">
                * Rotation in degrees
            </div>
            
            <div class="mb-2">
                <div class="form-check form-check-inline small">
                    <input class="form-check-input" type="radio" name="mode-@Car.Id" id="mode-fast-@Car.Id" 
                           checked="@FastMode" @onchange="@(() => UpdateFastMode(true))">
                    <label class="form-check-label" for="mode-fast-@Car.Id" title="Stop when limit reached">
                        Fast Mode
                    </label>
                </div>
                <div class="form-check form-check-inline small">
                    <input class="form-check-input" type="radio" name="mode-@Car.Id" id="mode-full-@Car.Id" 
                           checked="@(!FastMode)" @onchange="@(() => UpdateFastMode(false))">
                    <label class="form-check-label" for="mode-full-@Car.Id" title="Calculate all intersections (may be slow)">
                        Full Mode
                    </label>
                </div>
            </div>

            <button class="btn btn-primary btn-sm w-100 mb-2" @onclick="OnShowIntersections" disabled="@IsBusy">
                @if (IsBusy)
                {
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    <span> Computing...</span>
                }
                else
                {
                    <span>Show Intersections</span>
                }
            </button>

            @if (Result != null)
            {
                <div class="alert alert-info mt-2 p-2">
                    <small>
                        <div class="d-flex justify-content-between">
                            <span>Last calc time:</span>
                            <strong>@Result.TimeElapsedMs ms</strong>
                        </div>
                        <hr class="my-1"/>
                        <div>Lines hits: @Result.TotalHitsLines</div>
                        <div>Cars hits: @Result.TotalHitsCars</div>
                        <div>
                            Total: 
                            @if (Result.StoppedEarly)
                            {
                                <span class="badge bg-warning text-dark">@Result.LimitUsed+ (stopped early)</span>
                            }
                            else
                            {
                                <span>@Result.TotalIntersections</span>
                            }
                        </div>
                        
                        @if (Result.TotalIntersections > Result.MarkersToDraw.Count && !Result.StoppedEarly)
                        {
                             <div class="text-warning mt-1" style="font-weight: 600;">
                                <i class="bi bi-exclamation-triangle"></i> 
                                Showing first @Result.MarkersToDraw.Count of @Result.TotalIntersections intersections (increase limit to see more)
                            </div>
                        }
                        else if (Result.StoppedEarly)
                        {
                            <div class="text-warning mt-1" style="font-weight: 600;">
                                <i class="bi bi-exclamation-triangle"></i> 
                                Stopped early at @Result.LimitUsed (Fast Mode)
                            </div>
                        }

                            <div class="text-muted" style="font-size: 0.8em;">
                                <div>Build Car PixelSet: @(Result.BuildCarPixelSetMs > 0 ? $"{Result.BuildCarPixelSetMs} ms" : "cached")</div>
                                <div>Grid query: @Result.GridQueryMs ms</div>
                                <div>Narrow phase: @Result.NarrowPhaseMs ms</div>
                                <div>Collect results: @Result.CollectResultsMs ms</div>
                                @if (ShowDebugStats)
                                {
                                    <hr class="my-1"/>
                                    <div>Rejected (Line AABB): @Result.RejectedByLineAabb</div>
                                    <div>Rejected (Seg AABB): @Result.RejectedBySegmentAabb</div>
                                    <div>Bresenham Calls: @Result.ProcessedByBresenham</div>
                                }
                            </div>
                    </small>
                </div>
            }
        }
        else
        {
            <p>Car not loaded.</p>
        }
    </div>
</div>

@code {
    [Parameter] public string Title { get; set; } = "Car";
    [Parameter] public CarModel? Car { get; set; }
    [Parameter] public CarCanvas.Application.DTOs.IntersectionResult? Result { get; set; }
    [Parameter] public bool IsBusy { get; set; }
    [Parameter] public bool ShowDebugStats { get; set; }
    [Parameter] public bool FastMode { get; set; }
    [Parameter] public long RenderMs { get; set; }
    [Parameter] public bool IsRenderSimplified { get; set; }
    [Parameter] public EventCallback<(int x, int y, double rot)> OnTransformChange { get; set; }
    [Parameter] public EventCallback OnFindIntersections { get; set; }
    [Parameter] public EventCallback<bool> OnFastModeChange { get; set; }

    private async Task OnTransformChanged(string type, object? value)
    {
        if (Car == null || value == null) return;
        
        int x = Car.Transform.TranslateX;
        int y = Car.Transform.TranslateY;
        double rot = Car.Transform.RotationAngle;

        if (double.TryParse(value.ToString(), out double dVal))
        {
            int iVal = (int)dVal;
            if (type == "x") x = iVal;
            else if (type == "y") y = iVal;
            else if (type == "rot") rot = dVal;
            
            await OnTransformChange.InvokeAsync((x, y, rot));
        }
    }

    private async Task OnShowIntersections()
    {
        await OnFindIntersections.InvokeAsync();
    }

    private async Task UpdateFastMode(bool isFast)
    {
        await OnFastModeChange.InvokeAsync(isFast);
    }
}
