@page "/"
@using CarCanvas.Web.Components
@using CarCanvas.Web.ViewModels
@using CarCanvas.Application.Enums
@inject DashboardViewModel ViewModel
@inject ILogger<Home> AppLogger
@implements IDisposable

<PageTitle>CarCanvas - Dashboard</PageTitle>

<!-- Left/Top: Canvas Area -->
<div class="canvas-area">
    <div style="overflow: auto; max-width: 100%; max-height: 100%; box-shadow: var(--shadow-md); border-radius: var(--radius-md);">
        <CanvasView Id="mainCanvas" Width="2000" Height="400" Mode="ViewModel.CoordinateMode" />
    </div>
    
    @if (ViewModel.IsLoading)
    {
        <div class="loading-overlay">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
</div>

<!-- Right/Bottom: Controls Sidebar -->
<div class="controls-sidebar">
    <div class="sidebar-content" style="padding-right: 5px;">
        
        <!-- Section: Cars -->
        <h5 class="section-header border-bottom pb-2 mb-3">Cars (Transforms)</h5>
        <div class="d-flex flex-column gap-3 mb-4">
            <CarControlPanel Title="Car #1 (Blue)" 
                                Car="ViewModel.Car1" 
                                Result="ViewModel.ResultCar1"
                                IsBusy="ViewModel.IsLoading"
                                ShowDebugStats="ViewModel.ShowDebug"
                                OnTransformChange="@(t => ViewModel.UpdateTransformAsync(1, t.x, t.y, t.rot))"
                                OnFindIntersections="@(() => ViewModel.FindIntersectionsAsync(1))" />

            <CarControlPanel Title="Car #2 (Green)" 
                                Car="ViewModel.Car2" 
                                Result="ViewModel.ResultCar2"
                                IsBusy="ViewModel.IsLoading"
                                ShowDebugStats="ViewModel.ShowDebug"
                                OnTransformChange="@(t => ViewModel.UpdateTransformAsync(2, t.x, t.y, t.rot))"
                                OnFindIntersections="@(() => ViewModel.FindIntersectionsAsync(2))" />
        </div>

        <!-- Section: Lines -->
        <h5 class="section-header border-bottom pb-2 mb-3">Lines</h5>
        <div class="mb-4">
            <LineControlPanel TotalLines="ViewModel.Lines.Count"
                                ShowDebug="ViewModel.ShowDebug"
                                OnAddLine="@(l => ViewModel.AddLineAsync(l.x1, l.y1, l.x2, l.y2))"
                                OnGenerate="@(n => ViewModel.GenerateRandomLinesAsync(n))"
                                OnClear="@(() => ViewModel.ClearLinesAsync())"
                                OnDebugChange="@(v => ViewModel.ToggleDebugAsync(v))" />
        </div>

        <!-- Section: Data / Config -->
        <h5 class="section-header border-bottom pb-2 mb-3">Data / Config</h5>
        <div class="d-flex flex-column gap-3 mb-4">
            <div class="card-modern">
                <div class="card-body p-3">
                    <label class="form-label fw-bold small">Coordinate System</label>
                    <select class="form-select form-select-sm mb-2" @onchange="@(async (e) => await ViewModel.SetCoordinateModeAsync(Enum.Parse<CoordinateMode>(e.Value!.ToString()!)))">
                        <option value="@CoordinateMode.CanvasYDown" selected="@(ViewModel.CoordinateMode == CoordinateMode.CanvasYDown)">Canvas (Y down)</option>
                        <option value="@CoordinateMode.MathYUp" selected="@(ViewModel.CoordinateMode == CoordinateMode.MathYUp)">Math / CAD (Y up)</option>
                    </select>

                    <label class="form-label fw-bold small mt-2">Markers Limit</label>
                    <select class="form-select form-select-sm mb-2" @onchange="@(e => ViewModel.UpdateMarkersLimit(int.Parse(e.Value!.ToString()!)))">
                        <option value="2000" selected="@(ViewModel.GetMaxMarkers() == 2000)">2,000</option>
                        <option value="5000" selected="@(ViewModel.GetMaxMarkers() == 5000)">5,000 (Default)</option>
                        <option value="10000" selected="@(ViewModel.GetMaxMarkers() == 10000)">10,000</option>
                        <option value="50000" selected="@(ViewModel.GetMaxMarkers() == 50000)">50,000</option>
                        <option value="200000" selected="@(ViewModel.GetMaxMarkers() == 200000)">200,000 (Warning: Slow)</option>
                    </select>

                    <div class="text-muted" style="font-size: 0.75rem;">
                        <i class="bi bi-info-circle"></i> Field size: 2000 x 400 px
                        <br/>
                        <i class="bi bi-rulers"></i> Scale: 1 px = 1 cm
                    </div>
                </div>
            </div>

            <div class="card-modern">
                <div class="card-header-modern">Data Source</div>
                <div class="d-flex flex-column gap-3">
                    <div>
                        <label class="form-label mb-1 text-muted small">Upload File (.txt)</label>
                        <InputFile OnChange="LoadFile" class="form-control form-control-sm" accept=".txt" />
                    </div>
                    
                    <div class="d-flex align-items-center gap-2">
                        <div class="flex-grow-1 border-top" style="border-color: var(--border-color) !important;"></div>
                        <span class="text-muted small">OR</span>
                        <div class="flex-grow-1 border-top" style="border-color: var(--border-color) !important;"></div>
                    </div>

                    <button class="btn-secondary-modern w-full btn-sm" @onclick="LoadSample" disabled="@ViewModel.IsLoading">
                        Load Sample (Logan.txt)
                    </button>

                    @if (ViewModel.LoadedPointsCount.HasValue)
                    {
                        <div class="alert alert-info py-2 px-3 mb-0 mt-2 small">
                            <div><strong>Source:</strong> @ViewModel.LoadedSourceName</div>
                            <div><strong>Loaded Points:</strong> @ViewModel.LoadedPointsCount</div>
                        </div>
                    }
                </div>
            </div>
            
            @if (ViewModel.ErrorMessage != null)
            {
                <div class="alert alert-danger mt-3 small">@ViewModel.ErrorMessage</div>
            }
        </div>
    </div>
</div>

@code {
    private string activeTab = "cars";

    protected override void OnInitialized()
    {
        ViewModel.OnChange += StateHasChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                await ViewModel.InitializeAsync();
            }
            catch (Exception ex)
            {
                AppLogger.LogError(ex, "Error initializing Home component");
                ViewModel.SetError($"Initialization error: {ex.Message}");
            }
        }
    }

    public void Dispose()
    {
        ViewModel.OnChange -= StateHasChanged;
    }

    private async Task LoadFile(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;
        long maxFileSize = 1024 * 1024 * 2; 

        try
        {
            using var stream = file.OpenReadStream(maxFileSize);
            await ViewModel.LoadCarFromFileAsync(stream, file.Name);
        }
        catch (Exception ex)
        {
            ViewModel.SetError($"File read error: {ex.Message}");
        }
    }

    private async Task LoadSample()
    {
        await ViewModel.LoadSampleCarAsync();
    }
}
