@page "/"
@using CarCanvas.Web.Components
@using CarCanvas.Web.ViewModels
@using CarCanvas.Application.Enums
@inject DashboardViewModel ViewModel
@implements IDisposable

<PageTitle>CarCanvas - Dashboard</PageTitle>

<!-- Left/Top: Canvas Area -->
<div class="canvas-area">
    <div style="overflow: auto; max-width: 100%; max-height: 100%; box-shadow: var(--shadow-md); border-radius: var(--radius-md);">
        <CanvasView Id="mainCanvas" Width="2000" Height="400" />
    </div>
    
    @if (ViewModel.IsLoading)
    {
        <div class="loading-overlay">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
</div>

<!-- Right/Bottom: Controls Sidebar -->
<div class="controls-sidebar">
    <!-- Tabs Navigation -->
    <div class="tabs-nav">
        <div class="tab-link @(activeTab == "cars" ? "active" : "")" @onclick="@(() => activeTab = "cars")">Cars</div>
        <div class="tab-link @(activeTab == "lines" ? "active" : "")" @onclick="@(() => activeTab = "lines")">Lines</div>
        <div class="tab-link @(activeTab == "data" ? "active" : "")" @onclick="@(() => activeTab = "data")">Data</div>
    </div>

    <div class="sidebar-content">
        @if (activeTab == "cars")
        {
            <div class="d-flex flex-column gap-3">
                <CarControlPanel Title="Car #1 (Blue)" 
                                 Car="ViewModel.Car1" 
                                 Result="ViewModel.ResultCar1"
                                 IsBusy="ViewModel.IsLoading"
                                 ShowDebugStats="ViewModel.ShowDebug"
                                 OnTransformChange="@(t => ViewModel.UpdateTransformAsync(1, t.x, t.y, t.rot))"
                                 OnFindIntersections="@(() => ViewModel.FindIntersectionsAsync(1))" />

                <CarControlPanel Title="Car #2 (Green)" 
                                 Car="ViewModel.Car2" 
                                 Result="ViewModel.ResultCar2"
                                 IsBusy="ViewModel.IsLoading"
                                 ShowDebugStats="ViewModel.ShowDebug"
                                 OnTransformChange="@(t => ViewModel.UpdateTransformAsync(2, t.x, t.y, t.rot))"
                                 OnFindIntersections="@(() => ViewModel.FindIntersectionsAsync(2))" />
            </div>
        }
        else if (activeTab == "lines")
        {
            <LineControlPanel TotalLines="ViewModel.Lines.Count"
                              ShowDebug="ViewModel.ShowDebug"
                              OnAddLine="@(l => ViewModel.AddLineAsync(l.x1, l.y1, l.x2, l.y2))"
                              OnGenerate="@(n => ViewModel.GenerateRandomLinesAsync(n))"
                              OnClear="@(() => ViewModel.ClearLinesAsync())"
                              OnDebugChange="@(v => ViewModel.ToggleDebugAsync(v))" />
        }
        else if (activeTab == "data")
        {
             <div class="card-modern">
                <div class="card-header-modern">Configuration</div>
                <div class="d-flex flex-column gap-3">
                    <div>
                        <label class="form-label mb-1 text-muted small">Coordinate System</label>
                        <select class="form-select" @onchange="@(async (e) => await ViewModel.SetCoordinateModeAsync(Enum.Parse<CoordinateMode>(e.Value!.ToString()!)))">
                            <option value="@CoordinateMode.CanvasYDown" selected="@(ViewModel.CoordinateMode == CoordinateMode.CanvasYDown)">Canvas (Y down)</option>
                            <option value="@CoordinateMode.MathYUp" selected="@(ViewModel.CoordinateMode == CoordinateMode.MathYUp)">Math / CAD (Y up)</option>
                        </select>
                    </div>
                </div>
             </div>

             <div class="card-modern mt-3">
                <div class="card-header-modern">Data Source</div>
                <div class="d-flex flex-column gap-3">
                    <div>
                        <label class="form-label mb-1 text-muted small">Upload File (.txt)</label>
                        <InputFile OnChange="LoadFile" class="form-control" accept=".txt" />
                    </div>
                    
                    <div class="d-flex align-items-center gap-2">
                        <div class="flex-grow-1 border-top" style="border-color: var(--border-color) !important;"></div>
                        <span class="text-muted small">OR</span>
                        <div class="flex-grow-1 border-top" style="border-color: var(--border-color) !important;"></div>
                    </div>

                    <button class="btn-secondary-modern w-full" @onclick="LoadSample" disabled="@ViewModel.IsLoading">
                        Load Sample (Logan.txt)
                    </button>

                    @if (ViewModel.LoadedPointsCount.HasValue)
                    {
                        <div class="alert alert-info py-2 px-3 mb-0 mt-2 small">
                            <div><strong>Source:</strong> @ViewModel.LoadedSourceName</div>
                            <div><strong>Points:</strong> @ViewModel.LoadedPointsCount</div>
                        </div>
                    }
                </div>
            </div>
            
            @if (ViewModel.ErrorMessage != null)
            {
                <div class="alert alert-danger mt-3">@ViewModel.ErrorMessage</div>
            }
        }
    </div>
</div>

@code {
    private string activeTab = "cars";

    protected override async Task OnInitializedAsync()
    {
        ViewModel.OnChange += StateHasChanged;
        await ViewModel.InitializeAsync();
    }

    public void Dispose()
    {
        ViewModel.OnChange -= StateHasChanged;
    }

    private async Task LoadFile(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;
        long maxFileSize = 1024 * 1024 * 2; 

        try
        {
            using var stream = file.OpenReadStream(maxFileSize);
            await ViewModel.LoadCarFromFileAsync(stream, file.Name);
        }
        catch (Exception ex)
        {
            ViewModel.SetError($"File read error: {ex.Message}");
        }
    }

    private async Task LoadSample()
    {
        await ViewModel.LoadSampleCarAsync();
    }
}
