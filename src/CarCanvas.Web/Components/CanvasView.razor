@inject CarCanvas.Application.Interfaces.ICanvasSceneService CanvasService
@inject ILogger<CanvasView> CanvasLogger
@using Microsoft.Extensions.Logging
@using CarCanvas.Application.Enums

<div style="display: flex; flex-direction: column; width: fit-content;">
    <canvas id="@Id" width="@Width" height="@Height" 
            style="border: 1px solid #ccc; background-color: #f8f9fa; cursor: url('data:image/svg+xml;utf8,<svg width=%2224%22 height=%2224%22 viewBox=%220 0 24 24%22 xmlns=%22http://www.w3.org/2000/svg%22><path d=%22M12 1v22M1 12h22%22 stroke=%22red%22 stroke-width=%222%22/></svg>') 12 12, crosshair;"
            @onmousemove="HandleMouseMove"
            @onmouseout="() => _showCoords = false"></canvas>

    @if (_showCoords)
    {
        <div style="position: fixed; bottom: 10px; left: 10px; z-index: 1000; background-color: rgba(255, 255, 255, 0.9); padding: 5px 10px; border: 1px solid #ccc; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); font-family: monospace; font-size: 14px; color: #333;">
            <i class="bi bi-crosshair"></i> X: <strong>@_mouseX</strong>, Y: <strong>@_mouseY</strong>
        </div>
    }
</div>

@code {
    [Parameter] public string Id { get; set; } = "mainCanvas";
    [Parameter] public int Width { get; set; } = 2000;
    [Parameter] public int Height { get; set; } = 400;
    [Parameter] public CoordinateMode Mode { get; set; } = CoordinateMode.MathYUp;

    private double _mouseX;
    private double _mouseY;
    private bool _showCoords;

    private void HandleMouseMove(MouseEventArgs e)
    {
        _mouseX = e.OffsetX;
        
        // If Math mode, invert Y
        if (Mode == CoordinateMode.MathYUp)
        {
            _mouseY = Height - e.OffsetY;
        }
        else
        {
            _mouseY = e.OffsetY;
        }
        
        _showCoords = true;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                await CanvasService.InitializeAsync(Id);
            }
            catch (Exception ex)
            {
                CanvasLogger.LogError(ex, "Failed to initialize Canvas with Id: {Id}", Id);
            }
        }
    }
}
