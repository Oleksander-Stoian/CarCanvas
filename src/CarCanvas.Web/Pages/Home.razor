@page "/"
@using CarCanvas.Web.Components
@using CarCanvas.Web.ViewModels
@inject DashboardViewModel ViewModel
@implements IDisposable

<PageTitle>CarCanvas Intersections</PageTitle>

<div class="container-fluid p-3">
    <div class="row mb-3">
        <div class="col-12" style="overflow-x: auto;">
            <CanvasView Id="mainCanvas" Width="2000" Height="400" />
        </div>
    </div>

    <!-- File Upload Section -->
    <div class="card mb-3">
        <div class="card-body">
            <h5 class="card-title">Car Data Source</h5>
            <div class="d-flex flex-wrap align-items-center gap-3">
                <div class="d-flex align-items-center gap-2">
                     <label class="form-label mb-0 fw-bold">Upload car file (.txt):</label>
                     <InputFile OnChange="LoadFile" class="form-control form-control-sm" style="width: auto;" accept=".txt" />
                </div>
                
                <div class="vr"></div>
                
                <button class="btn btn-outline-secondary btn-sm" @onclick="LoadSample" disabled="@ViewModel.IsLoading">
                    Load sample (Logan.txt)
                </button>

                @if (ViewModel.LoadedPointsCount.HasValue)
                {
                    <div class="ms-auto text-muted small">
                        <strong>Source:</strong> @ViewModel.LoadedSourceName | 
                        <strong>Loaded points:</strong> @ViewModel.LoadedPointsCount
                    </div>
                }
            </div>
        </div>
    </div>

    @if (ViewModel.ErrorMessage != null)
    {
        <div class="alert alert-danger">@ViewModel.ErrorMessage</div>
    }

    <div class="row">
        <div class="col-md-4">
            <CarControlPanel Title="Car #1 (Blue)" 
                             Car="ViewModel.Car1" 
                             Result="ViewModel.ResultCar1"
                             IsBusy="ViewModel.IsLoading"
                             OnTransformChange="@(t => ViewModel.UpdateTransformAsync(1, t.x, t.y, t.rot))"
                             OnFindIntersections="@(() => ViewModel.FindIntersectionsAsync(1))" />
        </div>
        <div class="col-md-4">
            <CarControlPanel Title="Car #2 (Green)" 
                             Car="ViewModel.Car2" 
                             Result="ViewModel.ResultCar2"
                             IsBusy="ViewModel.IsLoading"
                             OnTransformChange="@(t => ViewModel.UpdateTransformAsync(2, t.x, t.y, t.rot))"
                             OnFindIntersections="@(() => ViewModel.FindIntersectionsAsync(2))" />
        </div>
        <div class="col-md-4">
            <LineControlPanel TotalLines="ViewModel.Lines.Count"
                              OnAddLine="@(l => ViewModel.AddLineAsync(l.x1, l.y1, l.x2, l.y2))"
                              OnGenerate="@(n => ViewModel.GenerateRandomLinesAsync(n))"
                              OnClear="@(() => ViewModel.ClearLinesAsync())" />
        </div>
    </div>
</div>

@code {
    protected override async Task OnInitializedAsync()
    {
        ViewModel.OnChange += StateHasChanged;
        await ViewModel.InitializeAsync();
    }

    public void Dispose()
    {
        ViewModel.OnChange -= StateHasChanged;
    }

    private async Task LoadFile(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;

        // Limit size (e.g. 2 MB)
        long maxFileSize = 1024 * 1024 * 2; 

        try
        {
            using var stream = file.OpenReadStream(maxFileSize);
            await ViewModel.LoadCarFromFileAsync(stream, file.Name);
        }
        catch (Exception ex)
        {
            ViewModel.SetError($"File read error: {ex.Message}");
        }
    }

    private async Task LoadSample()
    {
        await ViewModel.LoadSampleCarAsync();
    }
}
